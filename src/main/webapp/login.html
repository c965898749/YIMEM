<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>登录</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Charisma, a fully featured, responsive, HTML5, Bootstrap admin template.">
    <meta name="author" content="Muhammad Usman">
    <!-- 不使用浏览器缓存 -->
    <meta http-equiv="Pragma" content="no-cache">

    <!-- The styles -->
    <link href="css/bootstrap-cerulean.css" rel="stylesheet">
    <style type="text/css">
        body {
            padding-bottom: 40px;
        }

        .sidebar-nav {
            padding: 9px 0;
        }
        .form-horizontal2{
            display: none;
        }
        .form-horizontal{
            display: none;
        }
    </style>
    <!--<link rel="stylesheet" href="js/setCookie.js">-->
    <link href="css/bootstrap-responsive.css" rel="stylesheet">
    <link href="css/charisma-app.css" rel="stylesheet">
    <link href="css/jquery-ui-1.8.21.custom.css" rel="stylesheet">
    <link href='css/fullcalendar.css' rel='stylesheet'>
    <link href='css/fullcalendar.print.css' rel='stylesheet' media='print'>
    <link href='css/chosen.css' rel='stylesheet'>
    <link href='css/uniform.default.css' rel='stylesheet'>
    <link href='css/colorbox.css' rel='stylesheet'>
    <link href='css/jquery.cleditor.css' rel='stylesheet'>
    <link href='css/jquery.noty.css' rel='stylesheet'>
    <link href='css/noty_theme_default.css' rel='stylesheet'>
    <link href='css/elfinder.min.css' rel='stylesheet'>
    <link href='css/elfinder.theme.css' rel='stylesheet'>
    <link href='css/jquery.iphone.toggle.css' rel='stylesheet'>
    <link href='css/opa-icons.css' rel='stylesheet'>
    <link href='css/uploadify.css' rel='stylesheet'>

    <!-- The HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- The fav icon -->
    <link rel="shortcut icon" href="img/favicon.ico">

</head>

<body>
<div class="container-fluid">
    <div class="row-fluid">

        <div  class="row-fluid">
            <div class="span12 center login-header">
                <h2>帐号密码登录</h2>
            </div><!--/span-->
        </div><!--/row-->

        <div class="row-fluid">
            <div class="well span5 center login-box">

                <div class="alert alert-info">
                    <div class="form-horizontal2">请输入登陆账号和密码... <a href="resetPw.html">忘记密码？</a><img class="erwei"
                                                                                                      src="imgs/btn/blog/erwei.png" title="点击扫码快速登录"
                                                                                                      style="width: 20px;height: 20px;float: right;cursor: pointer"
                                                                                                      alt=""></div>
                    <div  class="saoma2">微信扫码登录... <span class="nub" style="color: #369BD7;cursor: pointer">账号登录？<img class="yiwen" title="需要关注公众号并绑定注册账号才能扫码登录"
                                                                                                                     src="imgs/btn/blog/yiwen.png"
                                                                                                                     style="width: 20px;height: 20px;float: right;cursor: pointer"
                                                                                                                     alt=""></span><a
                            href="index.html">首页</a>
                    </div>

                </div>

                <div id="qrcode" class="saoma" style="width: 200px;height: 200px;background-color: white;margin: 0 auto"></div>
                <div class="form-horizontal">
                    <fieldset>
                        <div class="input-prepend" title="登录账号" data-rel="tooltip">
                            <span class="add-on"><i class="icon-user"></i></span><input autofocus
                                                                                        class="input-large span10"
                                                                                        name="username" id="username"
                                                                                        type="text" value="" onkeydown='test()'/>
                        </div>
                        <div class="clearfix"></div>

                        <div class="input-prepend" title="登陆密码" data-rel="tooltip">
                            <span class="add-on"><i class="icon-lock"></i></span><input class="input-large span10"
                                                                                        name="userpassword"
                                                                                        id="userpassword"
                                                                                        type="password" value="" onkeydown='test()'/>
                        </div>
                        <div class="clearfix"></div>

                        <div class="input-prepend">
                            <input type="checkbox" id="remember" style="margin-top: -2px"><span
                                style="margin-right: 70px">记住账号</span><a href="register.html">注册</a><a
                                href="index.html">/首页</a>
                        </div>
                        <div class="clearfix"></div>
                        <ul id="formtip" style="height: 20px"></ul>
                        <p class="center span5" style="margin-top: -20px">
                            <button type="submit" class="btn btn-primary" id="loginBtn">登录</button>
                        </p>

                    </fieldset>
                </div>
            </div><!--/span-->
        </div><!--/row-->
    </div><!--/fluid-row-->
</div><!--/.fluid-container-->

<!-- external javascript
================================================== -->
<!-- Placed at the end of the document so the pages load faster -->
<script src="js/setCookie.js"></script>
<!-- jQuery -->
<script src="js/jquery-1.7.2.min.js"></script>
<!-- jQuery UI -->
<script src="js/jquery-ui-1.8.21.custom.min.js"></script>
<!-- transition / effect library -->
<script src="js/bootstrap-transition.js"></script>
<!-- alert enhancer library -->
<script src="js/bootstrap-alert.js"></script>
<!-- modal / dialog library -->
<script src="js/bootstrap-modal.js"></script>
<!-- custom dropdown library -->
<script src="js/bootstrap-dropdown.js"></script>
<!-- scrolspy library -->
<script src="js/bootstrap-scrollspy.js"></script>
<!-- library for creating tabs -->
<script src="js/bootstrap-tab.js"></script>
<!-- library for advanced tooltip -->
<script src="js/bootstrap-tooltip.js"></script>
<!-- popover effect library -->
<script src="js/bootstrap-popover.js"></script>
<!-- button enhancer library -->
<script src="js/bootstrap-button.js"></script>
<!-- accordion library (optional, not used in demo) -->
<script src="js/bootstrap-collapse.js"></script>
<!-- carousel slideshow library (optional, not used in demo) -->
<script src="js/bootstrap-carousel.js"></script>
<!-- autocomplete library -->
<script src="js/bootstrap-typeahead.js"></script>
<!-- tour library -->
<script src="js/bootstrap-tour.js"></script>
<!-- library for cookie management -->
<script src="js/jquery.cookie.js"></script>
<!-- calander plugin -->
<script src='js/fullcalendar.min.js'></script>
<!-- data table plugin -->
<script src='js/jquery.dataTables.min.js'></script>

<!-- chart libraries start -->
<script src="js/excanvas.js"></script>
<script src="js/jquery.flot.min.js"></script>
<script src="js/jquery.flot.pie.min.js"></script>
<script src="js/jquery.flot.stack.js"></script>
<script src="js/jquery.flot.resize.min.js"></script>
<!-- chart libraries end -->

<!-- select or dropdown enhancer -->
<script src="js/jquery.chosen.min.js"></script>
<!-- checkbox, radio, and file input styler -->
<script src="js/jquery.uniform.min.js"></script>
<!-- plugin for gallery image view -->
<script src="js/jquery.colorbox.min.js"></script>
<!-- rich text editor library -->
<script src="js/jquery.cleditor.min.js"></script>
<!-- notification plugin -->
<script src="js/jquery.noty.js"></script>
<!-- file manager library -->
<script src="js/jquery.elfinder.min.js"></script>
<!-- star rating plugin -->
<script src="js/jquery.raty.min.js"></script>
<!-- for iOS style toggle switch -->
<script src="js/jquery.iphone.toggle.js"></script>
<!-- autogrowing textarea plugin -->
<script src="js/jquery.autogrow-textarea.js"></script>
<!-- multiple file upload plugin -->
<script src="js/jquery.uploadify-3.1.min.js"></script>
<!-- history.js for cross-browser state change on ajax -->
<script src="js/jquery.history.js"></script>
<!-- application script for Charisma demo -->
<!--<script src="js/charisma.js"></script>-->
<!--<script src="localjs/index.js"></script>-->
<script src="js/qrcode.min.js"></script>

</body>
<script>
    // 2020 8/10不再使用的扫码登录方式
    // $(function () {
    //     runEvery10Sec()
    //     $.ajax({
    //         url: '/wechat/getURL',
    //         type: 'GET',
    //         dataType: 'text',
    //         error: function(){
    //
    //         },
    //         success: function(jsonData){
    //             //初始化存放二维码的div
    //             var qrcode = new QRCode(document.getElementById("qrcode"), {
    //                 width : 200,
    //                 height : 200
    //             });
    //             //window.location.href获取到URL
    //             qrcode.makeCode(jsonData);
    //             // qrcode.makeCode('https://www.baidu.com');
    //         }
    //     });
    // })

    // 2020 8/10 新的扫码登录方式
    $(function () {
        runEvery10Sec()
        $.ajax({
            url: 'wechat/getURL2',
            type: "get"
            , dataType: "json"
            , async: false,
            error: function(){

            },
            success: function(jsonData){
                var url_ticket = "https://mp.weixin.qq.com/cgi-bin/showqrcode?ticket=";
                if (jsonData.success == 1) {
                    var html=`<img src="${url_ticket+jsonData.data.ticket}" alt=""></div>`;
                    var  token = jsonData.data.token;
                    // 写入Cookie
                    setCookie('token',token,30)
                }
                $("#qrcode").append(html)
                // //初始化存放二维码的div
                // var qrcode = new QRCode(document.getElementById("qrcode"), {
                //     width : 200,
                //     height : 200
                // });
                // //window.location.href获取到URL
                // qrcode.makeCode(jsonData);
                // // qrcode.makeCode('https://www.baidu.com');
            }
        });
    })


    // 每隔  10 秒钟 运行一次，发送一个 ajax 请求
    function runEvery10Sec() {
        // 1000 * 10 = 10 秒钟
        setTimeout( runEvery10Sec, 1000 * 10 );

        //
        $.ajax({
            url: "isEnter"
            , type: "get"
            , dataType: "json"
            , async: false
            , success: function (jsonData) {
                ////////////////console.log(jsonData)
                if (jsonData.success == 1) {
                    if (document.referrer === '') {
                        location.href = "userHomepage.html"
                    } else if (document.referrer.indexOf('register.html') != -1) {
                        location.href = "index.html"
                    }else if(document.referrer.indexOf('resetPw.html') != -1){
                        location.href = "index.html"
                    }else {
                        location.href = document.referrer;
                    }
                }
            }
            , error: function (res) {
                ////////////////console.log("ajax提交错误")
            }
        })
    }

    $(".nub").click(function () {
        $(".form-horizontal").show()
        $(".form-horizontal2").show()
        $(".saoma").hide()
        $(".saoma2").hide()



    })
    $(".erwei").click(function () {
        $(".form-horizontal").hide()
        $(".form-horizontal2").hide()
        $(".saoma").show()
        $(".saoma2").show()


    })


    function test(frm,event){
        var event=window.event?window.event:event;
        if(event.keyCode==13){
            var user = new Object();
            user.username = $.trim($("#username").val());
            user.userpassword = $.trim($("#userpassword").val());
            user.isStart = 1;
            if (user.username.indexOf("\'") != -1 || user.username.indexOf("\"") != -1 || user.username.indexOf("\\") != -1 || user.username.indexOf("/") != -1 || user.username.indexOf(";") != -1 || user.username.indexOf("%") != -1 || user.username.indexOf("#") != -1 || user.username.indexOf("(") != -1 || user.username.indexOf(")") != -1 || user.username.indexOf("*") != -1 || user.username.indexOf("&") != -1 || user.username.indexOf("|") != -1 || user.username.indexOf("<") != -1 || user.username.indexOf(">") != -1 || user.username.indexOf(",") != -1 || user.username.indexOf("$") != -1 || user.username.indexOf("^") != -1 || user.username.indexOf("{") != -1 || user.username.indexOf("}") != -1 || user.username.indexOf("[") != -1 || user.username.indexOf("]") != -1)
            {
                $("#username").focus();
                $("#formtip").css("color", "red");
                $("#formtip").html("用户名不能包含特殊字符！。");
                return false;
            }
            if (user.username == "" || user.username == null) {
                $("#username").focus();
                $("#formtip").css("color", "red");
                $("#formtip").html("对不起，登录账号不能为空。");
            } else if (user.userpassword == "" || user.userpassword == null) {
                $("#userpassword").focus();
                $("#formtip").css("color", "red");
                $("#formtip").html("对不起，登录密码不能为空。");
            } else {
                $("#formtip").html("");

                $.ajax({
                    url: 'loginVerification',
                    type: 'POST',
                    data: {"username": user.username, "userpassword": user.userpassword},
                    dataType: 'json',
                    timeout: 2000,
                    cache: false,
                    error: function () {
                        $("#formtip").css("color", "red");
                        $("#formtip").html("服务器无响应！请重试。");
                    },
                    success: function (jsonData) {
                        console.log(jsonData)
                        console.log(jsonData.success)
                        if (jsonData.success == 0) {
                            $("#formtip").css("color", "red");
                            $("#formtip").html(jsonData.errorMsg);
                            $("#username").val('');
                            $("#userpassword").val('');
                        } else {
                            $("#formtip").css("color", "green");
                            $("#formtip").html("您已登录成功!");
                            if ($("#remember").prop("checked")) {
                                var  token = jsonData.errorMsg;
                                // 写入Cookie
                                setCookie('token',token,30)
                            }
                            if (document.referrer === '') {
                                location.href = "userHomepage.html"
                            } else if (document.referrer.indexOf('register.html') != -1) {
                                location.href = "index.html"
                            }else if(document.referrer.indexOf('resetPw.html') != -1){
                                location.href = "index.html"
                            }else {
                                location.href = document.referrer;
                            }
                        }
                    }
                });
            }
        }
    }



    $("#loginBtn").click(function () {
        var user = new Object();
        user.username = $.trim($("#username").val());
        user.userpassword = $.trim($("#userpassword").val());
        user.isStart = 1;
        if (user.username.indexOf("\'") != -1 || user.username.indexOf("\"") != -1 || user.username.indexOf("\\") != -1 || user.username.indexOf("/") != -1 || user.username.indexOf(";") != -1 || user.username.indexOf("%") != -1 || user.username.indexOf("#") != -1 || user.username.indexOf("(") != -1 || user.username.indexOf(")") != -1 || user.username.indexOf("*") != -1 || user.username.indexOf("&") != -1 || user.username.indexOf("|") != -1 || user.username.indexOf("<") != -1 || user.username.indexOf(">") != -1 || user.username.indexOf(",") != -1 || user.username.indexOf("$") != -1 || user.username.indexOf("^") != -1 || user.username.indexOf("{") != -1 || user.username.indexOf("}") != -1 || user.username.indexOf("[") != -1 || user.username.indexOf("]") != -1)
        {
            $("#username").focus();
            $("#formtip").css("color", "red");
            $("#formtip").html("用户名不能包含特殊字符！。");
            return false;
        }
        if (user.username == "" || user.username == null) {
            $("#username").focus();
            $("#formtip").css("color", "red");
            $("#formtip").html("对不起，登录账号不能为空。");
        } else if (user.userpassword == "" || user.userpassword == null) {
            $("#userpassword").focus();
            $("#formtip").css("color", "red");
            $("#formtip").html("对不起，登录密码不能为空。");
        } else {
            $("#formtip").html("");

            $.ajax({
                url: 'loginVerification',
                type: 'POST',
                data: {"username": user.username, "userpassword": user.userpassword},
                dataType: 'json',
                timeout: 1000,
                cache: false,
                error: function () {
                    $("#formtip").css("color", "red");
                    $("#formtip").html("服务器无响应！请重试。");
                },
                success: function (jsonData) {
                    console.log(jsonData)
                    console.log(jsonData.success)
                    if (jsonData.success == 0) {
                        $("#formtip").css("color", "red");
                        $("#formtip").html(jsonData.errorMsg);
                        $("#username").val('');
                        $("#userpassword").val('');
                    } else {
                        $("#formtip").css("color", "green");
                        $("#formtip").html("您已登录成功!");
                       if ($("#remember").prop("checked")) {
                           var  token = jsonData.errorMsg;
                           // 写入Cookie
                           setCookie('token',token,30)
                       }
                        if (document.referrer === '') {
                            location.href = "userHomepage.html"
                        } else if (document.referrer.indexOf('register.html') != -1) {
                            location.href = "index.html"
                        }else if(document.referrer.indexOf('resetPw.html') != -1){
                            location.href = "index.html"
                        }else {
                            location.href = document.referrer;
                        }
                    }
                }
            });
        }
    });

</script>
</html>


